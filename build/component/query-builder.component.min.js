"use strict";var angular=require("angular"),query_conditions_1=require("./query.conditions"),query_interface_1=require("./query.interface"),QBKEY="$$QueryBuilder";String.prototype.replaceAt=function(e,t){var i=this.split("");return i[e]=t,i.join("")},Array.prototype.unique=function(){for(var e=this.concat(),t=0;t<e.length;++t)for(var i=t+1;i<e.length;++i)e[t]===e[i]&&e.splice(i--,1);return e};var QueryBuilderCtrl=function(){function e(e,t){this.$element=e,this.$scope=t,this.maxChips=1,this.multi=!1,this.operators=query_conditions_1.QUERY_OPERATORS,this.conditions=[],this.$event="",this.$queryString="",this.$outputUpdate=!1;var i=this;Object.keys(query_conditions_1.QUERY_CONDITIONS).forEach(function(e){i.conditions.push(query_conditions_1.QUERY_CONDITIONS[e])})}return e.prototype.$onInit=function(){this.group||(this.group=angular.copy(query_interface_1.QUERY_INTERFACE)),this.fieldValue||(this.fieldValue="value"),this.fieldName||(this.fieldName="name"),this.onGroupChange()},e.prototype.$doCheck=function(){if(!angular.equals(this.queryString,this.$queryString)){var e=this;this.$queryString=this.queryString,clearTimeout(this.$timeoutPromise),this.$timeoutPromise=setTimeout(function(){e.$outputUpdate=!0;var t=e.parseQuery(e.queryString),i=angular.toJson(t);e.group=JSON.parse(i),e.onGroupChange(),e.$scope.$digest()},500)}},e.prototype.split_string=function(e){if(e){var t=e.trim().split(/ /g),i=["(",")"],r=this,n=[],o="",s=[];this.conditions.map(function(e){var t=(Array.isArray(e.symbol)?e.symbol:[e.symbol]).map(function(e){return e.toLowerCase()});i=i.concat(t)}),this.fields.map(function(e){s.push(e[r.fieldName])}),this.operators.map(function(e){var t=(Array.isArray(e.name)?e.name:[e.name]).map(function(e){return e.toLowerCase()});i=i.concat(t)}),i=i.unique();var u=t.filter(function(e){return""!==e}),a=function(){var e=u.slice(0);u.forEach(function(e,t){var i=/\(|\)/g,r=e.length>1?i.exec(e):null;if(r){u.splice("("===r[0]?t:t+1,0,r[0]);var n=e.replaceAt(r.index,"");u.splice(")"===r[0]?t:t+1,1,n)}}),u.length!==e.length&&a()};a(),t=u.slice(0);for(var p=[],l=0,c=function(e){var r=t[e].trim();if(["(",")"].indexOf(r)===-1)if(o+=" "+t[e],p.push(e),i.indexOf(r.toLowerCase())>-1){var n=!!t[e-1]&&"NOT"===t[e-1].toUpperCase(),a=r;n&&(a=[t[e-1],r].join(" "),u.splice(e,1,a),u.splice(e-1,1,QBKEY));var c=o.replace(a,"").trim(),h=t[e-1]?t[e-1].trim():null;c&&[r,h].indexOf(c)<0&&(u.splice(e-1,1,c.trim()),p.forEach(function(t){t<e-1&&u.splice(t,1,QBKEY)})),p=[],o=""}else s.indexOf(o.trim())>-1&&(u.splice(e,1,o.trim()),p.forEach(function(t){t<e&&u.splice(t,1,QBKEY)}),p=[],o="");else")"===r&&(p=[],o="");l=e},h=0;h<t.length;h++)c(h);o&&u.splice(l,1,o.trim()),p.forEach(function(e){e<l&&u.splice(e,1,QBKEY)}),t=u.filter(function(e){return e!==QBKEY});var f=0,d=[];o="";do{if(t[f])if(i.indexOf(t[f].toLowerCase())<0){var y=/^and|AND|or|OR$`/g,g=y.exec(t[f]);g?(d.push(o),d.push(t[f])):o+=" "+t[f]}else if(["(",")"].indexOf(t[f].trim())!==-1)d.push(o),o="",d.push(t[f]);else{var y=/(["'`])(\\?.)*?\1/g,v=y.exec(o);v?d.push(v.input):d.push(o),t[f]&&d.push(t[f]),d.length>3&&(n=n.concat(d),d=[]),o=""}else d.push(o);f++}while(f<=t.length);return n=n.concat(d),n=n.filter(function(e){return""!==e}),n=n.map(function(e){return e.trim()})}},e.prototype.parseQuery=function(e){var t=this,i=this,r=this.split_string(e),n=[];this.operators.map(function(e){var t=(Array.isArray(e.name)?e.name:[e.name]).map(function(e){return e.toLowerCase()});n=n.concat(t)});var o=[];Object.keys(query_conditions_1.QUERY_CONDITIONS).forEach(function(e){var t=query_conditions_1.QUERY_CONDITIONS[e].symbol;o.push({symbol:Array.isArray(t)?t:[t],value:query_conditions_1.QUERY_CONDITIONS[e].value})});var s=function(){var e=angular.copy(query_interface_1.QUERY_INTERFACE);return Object.assign(e,{expressions:[]}),e},u=function(e){var t=angular.copy(query_interface_1.QUERY_INTERFACE.expressions[0]),r=/(["'`])(\\?.)*?\1/g,n=r.exec(e[2]),s=n?e[2].substring(1,e[2].length-1):e[2],u=r.exec(e[0]),a=u?e[0].substring(1,e[0].length-1):e[0];if(Object.assign(t,{values:[],field:i.fields.find(function(e){return a===e[i.fieldName]}),operator:o.find(function(t){return t.symbol.indexOf(e[1].toLowerCase())!==-1||t.symbol.indexOf(e[1].toUpperCase())!==-1}).value}),["BETWEEN","IN"].indexOf(e[1].toUpperCase())>-1){var p=s.split(",").map(function(e){return e.trim()});p.forEach(function(e){t.values.push(e)})}else t.values.push(s);return t.values=t.values.filter(function(e){return""!==e&&"``"!==e}),t},a=s(),p=function(e,i){var r=[];if(i)for(var o=0;o<i.length;o++){var a=i[o];if("$$QueryBuilder"===a)return;if("("===a){var l=s();e.expressions.push(l),i=i.filter(function(e){return"$$QueryBuilder"!==e});var c=/(\()?(?:[^()]+|\([^)]+\))+(\)?)/,h=c.exec(i.join(" "));if(h){var f=h[0].replace(/\(/,"").trim();f=f.replaceAt(f.length-1,"").trim();var d=i.join(" ").replace(f,"").replace(/\(\s{1,}\)/,"").trim();i=["$$QueryBuilder"].concat(t.split_string(d)||[]);var y=t.split_string(f)||[];y=y.filter(function(e){return e.trim()}),r=[],p(l,y)}}else")"===a||(n.indexOf(a.toLowerCase())===-1?(r.push(a),3===r.length&&e.expressions.push(u(r))):(e.op=a,r=[]));i[o]="$$QueryBuilder"}};return p(a,r),a},e.prototype.stringifyQuery=function(e){var t=this;if(e){var i=[];return angular.forEach(e.expressions,function(r,n){if("condition"===r.type){var o=r.values[0]?r.values.join(", "):"";if(!r.field||!r.field[t.fieldName])return;0!==n&&i.push(e.op),i.push(r.field[t.fieldName]);var s=t.conditions.find(function(e){return r.operator===e.value}).symbol;i.push(Array.isArray(s)?s[0]:s);var u="`";o&&i.push(t.$outputUpdate?o:u+o+u)}else{var a=t.stringifyQuery(r);a.length&&(i.length&&i.push(e.op),a.length>3&&(a.unshift("("),a.push(")")),i=i.concat(a))}}),i}},e.prototype.setOperator=function(e){var t=this;switch(e){case query_conditions_1.QUERY_CONDITIONS.IN.value:t.multi=!0,t.maxChips=9999;break;case query_conditions_1.QUERY_CONDITIONS.BETWEEN.value:t.multi=!0,t.maxChips=2;break;default:t.multi=!1,t.maxChips=1}},e.prototype.safeApply=function(e){var t=this.$scope;clearTimeout(this.$digestCycle),this.$digestCycle=setTimeout(function(){var i=t.$$phase;"$apply"==i||"$digest"==i?e&&"function"==typeof e&&e():t.$$phase||t.$apply(e)},0)},e.prototype.onTagsChange=function(e){this.$event="onTagsChange",this.onGroupChange(),this.safeApply()},e.prototype.onConditionChange=function(e,t){this.$event="onConditionChange",this.setOperator(e.operator),e.values.splice(this.maxChips),this.onGroupChange()},e.prototype.checkExpressions=function(e){var t=this,i=[],r=[];e.expressions.forEach(function(e,n){if("condition"===e.type){i.push(e);var o=!!e.values&&e.values[0],s=!!e.field&&e.field[t.fieldValue];o&&s&&r.push(n)}else t.checkExpressions(e)}),i.length>0&&r.length===i.length?this.AddCondition(e,r[r.length-1]+1):0==i.length&&this.AddCondition(e,0)},e.prototype.onGroupChange=function(e){clearTimeout(this.$timeoutPromise);this.$event=e||"onGroupChange",this.checkExpressions(this.group),this.setFieldsDescription(this.group),this.trigger("onUpdate")},e.prototype.setFieldsDescription=function(e){var t=this;e.expressions.forEach(function(e,i){!function(e){if("condition"===e.type){t.fields.map(function(i){return e.field&&e.field[t.fieldValue]===i[t.fieldValue]?e.field=i:e.field&&e.field[t.fieldName]===i[t.fieldName]?e.field=i:void 0})}else e=t.setFieldsDescription(e)}(e)})},e.prototype.AddCondition=function(e,t){var i=this,r=angular.copy(query_interface_1.QUERY_INTERFACE.expressions[0],{$$indeed:i.$countCondition,values:[]});t>-1?e.expressions.splice(t,0,r):e.expressions.push(r)},e.prototype.AddGroup=function(e){this.$event="AddGroup",this.group.expressions.push(angular.copy(query_interface_1.QUERY_INTERFACE))},e.prototype.RemoveGroup=function(e){this.$event="RemoveGroup";var t=this;this.onDelete({$event:{group:t.group}})},e.prototype.RemoveCondition=function(e,t){this.$event="RemoveCondition";var i=this;this.$countCondition=0,this.group.expressions.map(function(e){"condition"===e.type&&i.$countCondition++}),1!==i.$countCondition&&(i.group.expressions.splice(e,1),this.onGroupChange())},e.prototype.onDeleteGroup=function(e){var t=this,i=this.group.expressions.slice(0);i.forEach(function(i,r){i.$$hashKey===e.group.$$hashKey&&i.$$indeed===e.group.$$indeed&&t.group.expressions.splice(r,1)}),this.onGroupChange()},e.prototype.onUpdateGroup=function(e){this.trigger("onUpdate")},e.prototype.CleanObject=function(){for(var e,t=/\{"type":"condition".*?"values":\[\]\}/g,i=angular.toJson(this.group);null!==(e=t.exec(i));)e.index===t.lastIndex&&t.lastIndex++,e.forEach(function(e){try{var t=JSON.parse("["+e+"]");t.forEach(function(e){if(!e.values.length){var t=JSON.stringify(e).trim(),r=i.split(t);i=r.join("")}})}catch(e){}});return i=i.replace(/,\]/g,"]").replace(/\[,/g,"[").replace(/,,/g,","),JSON.parse(i)},e.prototype.trigger=function(e){var t=this,i=this.stringifyQuery(this.group);this.$queryString=this.queryString=i.join(" "),this.$outputUpdate=!1,this[e]({$event:{group:t.CleanObject(),string:t.queryString}})},e.prototype.$onDestroy=function(){clearTimeout(this.$timeoutPromise),clearTimeout(this.$digestCycle)},e}();QueryBuilderCtrl.$inject=["$element","$scope"],require("./query.less");var QueryBuilder=function(){function e(){this.bindings={onDelete:"&",onUpdate:"&",fieldValue:"@?",fieldName:"@?",queryString:"=?",$$index:"<",group:"=",fields:"<operands"},this.template=require("./query-builder.component.html"),this.controller=QueryBuilderCtrl}return e}();exports.QueryBuilder=QueryBuilder;